<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>TG Panel - Telegram Sessions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    :root {
      color-scheme: light;
      --bg: #faf8f5;
      --card-bg: #ffffff;
      --card-border: #e8e6e3;
      --accent: #d97706;
      --accent-soft: rgba(217,119,6,0.1);
      --accent-hover: #b45309;
      --text: #1f2937;
      --text-light: #4b5563;
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
      --warning: #ea580c;
      --border: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #fef3e2 0%, #faf8f5 50%, #f5f3f0 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 24px;
      line-height: 1.6;
    }
    .container {
      width: 100%;
      max-width: 1280px;
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.1fr);
      gap: 24px;
    }
    @media (max-width: 900px) {
      body {
        padding: 20px 16px;
      }
      .container {
        grid-template-columns: minmax(0, 1fr);
        gap: 20px;
      }
    }
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-md);
      padding: 28px 24px;
      position: relative;
      overflow: hidden;
    }
    .card-inner {
      position: relative;
      z-index: 1;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 16px;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }
    .title span.badge {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 4px 10px;
      border-radius: 6px;
      background: var(--accent-soft);
      border: 1px solid rgba(217,119,6,0.2);
      color: var(--accent);
      font-weight: 600;
    }
    .title-gradient {
      color: var(--text);
      font-weight: 700;
    }
    .pill {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-light);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--card-bg);
      box-shadow: var(--shadow-sm);
    }
    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 0 3px rgba(22,163,74,0.15);
    }
    .sessions-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 12px;
      margin-top: 8px;
      max-height: 500px;
      overflow: auto;
      padding-right: 8px;
    }
    @media (min-width: 1100px) {
      .sessions-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .session-card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 16px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }
    .session-card:hover {
      box-shadow: var(--shadow);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .session-main {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
    }
    .session-name {
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--muted);
      box-shadow: 0 0 0 2px rgba(107,114,128,0.2);
    }
    .status-dot.active {
      background: var(--success);
      box-shadow: 0 0 0 2px rgba(22,163,74,0.2);
    }
    .status-dot.syncing {
      background: var(--warning);
      box-shadow: 0 0 0 2px rgba(234,88,12,0.2);
    }
    .status-dot.error {
      background: var(--danger);
      box-shadow: 0 0 0 2px rgba(220,38,38,0.2);
    }
    .session-meta {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      flex-wrap: wrap;
      gap: 6px 8px;
    }
    .meta-pill {
      padding: 4px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--text-light);
      font-weight: 500;
    }
    .session-actions {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }
    button {
      border: none;
      cursor: pointer;
      font: inherit;
      color: inherit;
      background: transparent;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--accent);
      color: white;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      white-space: nowrap;
      cursor: pointer;
    }
    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
      border-color: var(--accent-hover);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn-ghost {
      background: var(--card-bg);
      border-color: var(--border);
      color: var(--text);
    }
    .btn-ghost:hover {
      background: #f9fafb;
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn-danger {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      background: #b91c1c;
      border-color: #b91c1c;
    }
    .btn-sm {
      padding: 4px 9px;
      font-size: 10px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      text-transform: none;
      letter-spacing: -0.01em;
      color: var(--text);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .section-title span.indicator {
      font-size: 11px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 10px;
    }
    label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: all 0.2s ease;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
      background: var(--card-bg);
    }
    input::placeholder, textarea::placeholder {
      color: var(--muted);
    }
    .helper {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
    }
    .code-input {
      letter-spacing: 0.32em;
      text-align: center;
      font-weight: 600;
    }
    .log {
      margin-top: 12px;
      font-size: 12px;
      max-height: 200px;
      overflow: auto;
      padding: 12px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid var(--border);
    }
    .log-line {
      color: var(--text-light);
      margin-bottom: 6px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.5;
    }
    .log-line time {
      color: var(--muted);
      font-size: 11px;
      margin-right: 8px;
      font-weight: 500;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--text-light);
      font-weight: 500;
    }
    .badge-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      border-radius: 8px;
      background: var(--accent-soft);
      border: 1px solid rgba(217,119,6,0.2);
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      padding: 0 6px;
    }
    .notif-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .notif-panel {
      width: 100%;
      max-width: 720px;
      max-height: 600px;
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .notif-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 16px;
      font-weight: 600;
      text-transform: none;
      letter-spacing: -0.01em;
      color: var(--text);
    }
    .notif-list {
      flex: 1;
      overflow: auto;
      padding-right: 4px;
      font-size: 12px;
    }
    .notif-item {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f9fafb;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: all 0.2s ease;
    }
    .notif-item:hover {
      background: #f3f4f6;
      border-color: var(--accent);
    }
    .notif-item.error {
      background: #fef2f2;
      border-color: rgba(220,38,38,0.3);
    }
    .notif-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .notif-link {
      color: var(--accent);
      word-break: break-all;
      font-weight: 500;
    }
    .notif-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .groups-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 45;
    }
    .groups-panel {
      width: 100%;
      max-width: 720px;
      max-height: 600px;
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .groups-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 16px;
      font-weight: 600;
      text-transform: none;
      letter-spacing: -0.01em;
      color: var(--text);
    }
    .groups-list {
      flex: 1;
      overflow: auto;
      padding-right: 4px;
      font-size: 12px;
    }
    .group-item {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f9fafb;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: all 0.2s ease;
    }
    .group-item:hover {
      background: #f3f4f6;
      border-color: var(--accent);
    }
    .group-title-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .group-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <main class="card">
      <div class="card-inner">
        <div class="card-header">
          <div>
            <div class="title">
              <span class="badge">TG PANEL</span>
              <span class="title-gradient">Telegram Sessions</span>
            </div>
            <div class="chips">
              <span class="chip">MTProto userbot</span>
              <span class="chip">Auto-join t.me</span>
              <span class="chip">Multi-session</span>
            </div>
          </div>
          <div class="pill">
            <span class="pill-dot"></span>
            <span>–ü–∞–Ω–µ–ª—å –æ–Ω–ª–∞–π–Ω</span>
          </div>
        </div>

        <div class="section-title">
          <span>–°–µ—Å—Å–∏–∏ Telegram</span>
          <span class="indicator">
            <span>–í—Å–µ–≥–æ: <span id="totalSessions">0</span></span>
          </span>
        </div>

        <div id="sessions" class="sessions-grid">
          <!-- Sessions will be rendered here -->
        </div>

        <div style="margin-top:8px; display:flex; justify-content:flex-end;">
          <button id="openNotifications" class="btn btn-ghost btn-sm">
            <span>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
          </button>
        </div>
      </div>
    </main>

    <aside class="card">
      <div class="card-inner">
        <div class="section-title">
          <span>–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è</span>
          <span class="indicator">
            <span id="currentStatus">–û–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥–∞‚Ä¶</span>
          </span>
        </div>

        <div class="field-group">
          <label for="sessionName">–ò–º—è —Å–µ—Å—Å–∏–∏</label>
          <input id="sessionName" placeholder="my_account_1" />
          <div class="helper">–õ–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _ –∏ -</div>
        </div>

        <div class="field-group">
          <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <input id="phone" placeholder="+79991234567" />
          <div class="helper">–ù–æ–º–µ—Ä Telegram-–∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è userbot-—Å–µ—Å—Å–∏–∏</div>
        </div>

        <button id="createSession" class="btn" style="width:100%; justify-content:center; margin-bottom:10px;">
          <span>‚ûï –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é</span>
        </button>

        <div class="field-group">
          <label for="authCode">–ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∏–∑ Telegram)</label>
          <input id="authCode" class="code-input" maxlength="10" placeholder="12345" />
          <div class="helper">–ü–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ —Å–µ—Å—Å–∏–∏ –∫–æ–¥ –ø—Ä–∏–¥—ë—Ç –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram</div>
        </div>

        <button id="confirmCode" class="btn btn-ghost" style="width:100%; justify-content:center;">
          <span>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</span>
        </button>

        <div class="section-title" style="margin-top:16px;">
          <span>–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É</span>
        </div>

        <div class="field-group">
          <label for="joinLink">t.me —Å—Å—ã–ª–∫–∞</label>
          <input id="joinLink" placeholder="https://t.me/your_group_or_invite" />
          <div class="helper">–í—ã–¥–µ–ª–µ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –≤—Å—Ç—É–ø–∏—Ç –≤ –≥—Ä—É–ø–ø—É –ø–æ —Å—Å—ã–ª–∫–µ</div>
        </div>

        <button id="joinGroup" class="btn btn-ghost" style="width:100%; justify-content:center;">
          <span>üîó –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ</span>
        </button>

        <div class="section-title" style="margin-top:16px;">
          <span>–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã</span>
        </div>

        <div class="field-group">
          <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è–º–∏ (—Å–µ–∫.)</label>
          <div style="display:flex; gap:8px;">
            <input id="intervalMin" type="number" min="3" max="3600" style="flex:1;" placeholder="–º–∏–Ω, –Ω–∞–ø—Ä. 5" />
            <input id="intervalMax" type="number" min="3" max="3600" style="flex:1;" placeholder="–º–∞–∫—Å, –Ω–∞–ø—Ä. 30" />
          </div>
          <div class="helper">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5‚Äì30 —Å–µ–∫. –î–∏–∞–ø–∞–∑–æ–Ω 3‚Äì3600 —Å–µ–∫.</div>
        </div>

        <button id="saveIntervals" class="btn btn-ghost" style="width:100%; justify-content:center;">
          <span>‚è±Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã</span>
        </button>

        <div class="log" id="log"></div>
      </div>
    </aside>
  </div>

  <div id="notifOverlay" class="notif-overlay">
    <div class="notif-panel">
      <div class="notif-header">
        <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π</span>
        <div style="display:flex; gap:6px;">
          <button id="clearNotifications" class="btn btn-sm btn-ghost">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="closeNotifications" class="btn btn-sm btn-danger">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
      <div id="notifList" class="notif-list"></div>
    </div>
  </div>

  <div id="groupsOverlay" class="groups-overlay">
    <div class="groups-panel">
      <div class="groups-header">
        <span id="groupsTitle">–ì—Ä—É–ø–ø—ã —Å–µ—Å—Å–∏–∏</span>
        <button id="closeGroups" class="btn btn-sm btn-danger">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="groupsList" class="groups-list"></div>
    </div>
  </div>

  <div id="broadcastOverlay" class="groups-overlay">
    <div class="groups-panel" style="max-width: 600px;">
      <div class="groups-header">
        <span id="broadcastTitle">üì¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏</span>
        <button id="closeBroadcast" class="btn btn-sm btn-danger">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <div class="field-group">
          <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
          <textarea id="broadcastText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏..." style="min-height: 80px; resize: vertical; font-family: inherit;"></textarea>
        </div>
        <div class="field-group">
          <label>URL –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input id="broadcastMediaUrl" placeholder="https://example.com/image.jpg" />
          <div class="helper">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã</div>
        </div>
        <div class="field-group">
          <label>–¢–∏–ø –º–µ–¥–∏–∞</label>
          <select id="broadcastMediaType" style="width: 100%; padding: 7px 10px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.6); background: rgba(15,23,42,0.9); color: var(--text); font-size: 13px;">
            <option value="">–ë–µ–∑ –º–µ–¥–∏–∞ (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç)</option>
            <option value="image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
            <option value="video">–í–∏–¥–µ–æ</option>
            <option value="document">–î–æ–∫—É–º–µ–Ω—Ç</option>
          </select>
        </div>
        <div class="field-group">
          <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ (—Å–µ–∫.)</label>
          <div style="display:flex; gap:8px;">
            <input id="broadcastMinInterval" type="number" min="3" max="3600" style="flex:1;" placeholder="–º–∏–Ω, –Ω–∞–ø—Ä. 5" value="5" />
            <input id="broadcastMaxInterval" type="number" min="3" max="3600" style="flex:1;" placeholder="–º–∞–∫—Å, –Ω–∞–ø—Ä. 15" value="15" />
          </div>
        </div>
        <div class="field-group">
          <label>
            <input type="checkbox" id="broadcastScheduled" style="width: auto; margin-right: 8px;" />
            –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
          </label>
          <input id="broadcastScheduleTime" placeholder="—Å–µ–≥–æ–¥–Ω—è 18:00, –∑–∞–≤—Ç—Ä–∞ 09:00, —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞" style="display: none;" />
          <div class="helper" id="broadcastScheduleHelper" style="display: none;">–§–æ—Ä–º–∞—Ç—ã: "—Å–µ–≥–æ–¥–Ω—è –ß–ß:–ú–ú", "–∑–∞–≤—Ç—Ä–∞ –ß–ß:–ú–ú", "—á–µ—Ä–µ–∑ N —á–∞—Å–æ–≤/–º–∏–Ω—É—Ç"</div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button id="startBroadcast" class="btn" style="flex: 1; justify-content: center;">
            <span>üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</span>
          </button>
          <button id="cancelBroadcast" class="btn btn-ghost" style="flex: 1; justify-content: center;">
            <span>‚ùå –û—Ç–º–µ–Ω–∞</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const sessionsContainer = document.getElementById('sessions');
    const totalSessionsSpan = document.getElementById('totalSessions');
    const currentStatusSpan = document.getElementById('currentStatus');
    const logEl = document.getElementById('log');

    const createSessionBtn = document.getElementById('createSession');
    const confirmCodeBtn = document.getElementById('confirmCode');
    const joinGroupBtn = document.getElementById('joinGroup');
      const saveIntervalsBtn = document.getElementById('saveIntervals');
      const openNotificationsBtn = document.getElementById('openNotifications');
      const closeNotificationsBtn = document.getElementById('closeNotifications');
      const clearNotificationsBtn = document.getElementById('clearNotifications');
      const groupsOverlay = document.getElementById('groupsOverlay');
      const groupsTitle = document.getElementById('groupsTitle');
      const groupsList = document.getElementById('groupsList');
      const closeGroupsBtn = document.getElementById('closeGroups');

    const sessionNameInput = document.getElementById('sessionName');
    const phoneInput = document.getElementById('phone');
    const authCodeInput = document.getElementById('authCode');
    const joinLinkInput = document.getElementById('joinLink');
      const intervalMinInput = document.getElementById('intervalMin');
      const intervalMaxInput = document.getElementById('intervalMax');
      const notifOverlay = document.getElementById('notifOverlay');
      const notifList = document.getElementById('notifList');

    let lastCreatedSession = null;
    let lastNotifications = [];
    let lastGroups = [];
    let currentGroupsSession = null;
    let currentBroadcastSession = null;
    const broadcastOverlay = document.getElementById('broadcastOverlay');
    const broadcastTitle = document.getElementById('broadcastTitle');
    const broadcastText = document.getElementById('broadcastText');
    const broadcastMediaUrl = document.getElementById('broadcastMediaUrl');
    const broadcastMediaType = document.getElementById('broadcastMediaType');
    const broadcastMinInterval = document.getElementById('broadcastMinInterval');
    const broadcastMaxInterval = document.getElementById('broadcastMaxInterval');
    const broadcastScheduled = document.getElementById('broadcastScheduled');
    const broadcastScheduleTime = document.getElementById('broadcastScheduleTime');
    const broadcastScheduleHelper = document.getElementById('broadcastScheduleHelper');
    const startBroadcastBtn = document.getElementById('startBroadcast');
    const cancelBroadcastBtn = document.getElementById('cancelBroadcast');
    const closeBroadcastBtn = document.getElementById('closeBroadcast');

    function log(message, type = 'info') {
      const line = document.createElement('div');
      line.className = 'log-line';
      const ts = document.createElement('time');
      ts.textContent = new Date().toLocaleTimeString('ru-RU', { hour12: false });
      line.appendChild(ts);
      const span = document.createElement('span');
      span.textContent = ' ' + message;
        if (type === 'error') {
        span.style.color = 'var(--danger)';
        span.style.fontWeight = '500';
      } else if (type === 'success') {
        span.style.color = 'var(--success)';
        span.style.fontWeight = '500';
      } else if (type === 'info') {
        span.style.color = 'var(--text-light)';
      }
      line.appendChild(span);
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function renderGroups() {
      groupsList.innerHTML = '';
      if (!lastGroups.length) {
        const empty = document.createElement('div');
        empty.textContent = '–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ —Å–µ—Å—Å–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞.';
        empty.style.color = 'var(--text-light)';
        empty.style.padding = '20px';
        empty.style.textAlign = 'center';
        groupsList.appendChild(empty);
        return;
      }
      lastGroups.forEach((g) => {
        const item = document.createElement('div');
        item.className = 'group-item';

        const top = document.createElement('div');
        top.className = 'group-title-line';
        const title = document.createElement('div');
        title.textContent = g.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)';
        const badge = document.createElement('span');
        badge.className = 'badge-number';
        badge.textContent = g.type === 'supergroup' ? 'SG' : 'CHAT';
        top.appendChild(title);
        top.appendChild(badge);
        item.appendChild(top);

        const meta = document.createElement('div');
        meta.className = 'group-meta';
        const idSpan = document.createElement('span');
        idSpan.textContent = 'ID: ' + g.id;
        meta.appendChild(idSpan);
        item.appendChild(meta);

        groupsList.appendChild(item);
      });
    }

    function statusText(status) {
      switch (status) {
        case 'active': return '–ê–∫—Ç–∏–≤–Ω–∞';
        case 'auth': return '–û–∂–∏–¥–∞–µ—Ç –∫–æ–¥–∞';
        case 'error': return '–û—à–∏–±–∫–∞';
        case 'inactive':
        default: return '–ù–µ –∞–∫—Ç–∏–≤–Ω–∞';
      }
    }

    function renderNotifications() {
      notifList.innerHTML = '';
      if (!lastNotifications.length) {
        const empty = document.createElement('div');
        empty.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.';
        empty.style.color = 'var(--text-light)';
        empty.style.padding = '20px';
        empty.style.textAlign = 'center';
        notifList.appendChild(empty);
        return;
      }
      lastNotifications.forEach((n) => {
        const item = document.createElement('div');
        item.className = 'notif-item' + (n.success ? '' : ' error');
        const top = document.createElement('div');
        top.className = 'notif-top';
        const title = document.createElement('div');
        title.textContent = n.success ? '‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ' : '‚ùå –û—à–∏–±–∫–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è';
        const time = document.createElement('div');
        const d = new Date(n.at);
        time.textContent = d.toLocaleTimeString('ru-RU', { hour12: false }) + ' ' + d.toLocaleDateString('ru-RU');
        time.style.fontSize = '12px';
        time.style.color = 'var(--text-light)';
        time.style.fontWeight = '500';
        top.appendChild(title);
        top.appendChild(time);
        item.appendChild(top);

        const link = document.createElement('div');
        link.className = 'notif-link';
        link.textContent = n.link;
        item.appendChild(link);

        const meta = document.createElement('div');
        meta.className = 'notif-meta';
        const s = document.createElement('span');
        s.textContent = '–°–µ—Å—Å–∏—è: ' + n.session;
        meta.appendChild(s);
        if (!n.success && n.error) {
          const err = document.createElement('span');
          err.textContent = '–û—à–∏–±–∫–∞: ' + n.error;
          meta.appendChild(err);
        }
        item.appendChild(meta);

        notifList.appendChild(item);
      });
    }

    function renderSessions(sessions) {
      sessionsContainer.innerHTML = '';
      totalSessionsSpan.textContent = sessions.length;
      if (!sessions.length) {
        const empty = document.createElement('div');
        empty.textContent = '–°–µ—Å—Å–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Å–ø—Ä–∞–≤–∞.';
        empty.style.fontSize = '14px';
        empty.style.color = 'var(--text-light)';
        empty.style.padding = '40px 20px';
        empty.style.textAlign = 'center';
        sessionsContainer.appendChild(empty);
        return;
      }

      sessions.forEach(s => {
        const card = document.createElement('div');
        card.className = 'session-card';

        const main = document.createElement('div');
        main.className = 'session-main';

        const left = document.createElement('div');
        const name = document.createElement('div');
        name.className = 'session-name';
        const dot = document.createElement('span');
        dot.className = 'status-dot ' + (s.status || 'inactive');
        name.appendChild(dot);
        const nameText = document.createElement('span');
        nameText.textContent = s.name;
        name.appendChild(nameText);
        left.appendChild(name);

        const meta = document.createElement('div');
        meta.className = 'session-meta';
        const st = document.createElement('span');
        st.className = 'meta-pill';
        st.textContent = '–°—Ç–∞—Ç—É—Å: ' + statusText(s.status);
        meta.appendChild(st);
        if (s.phone) {
          const ph = document.createElement('span');
          ph.className = 'meta-pill';
          ph.textContent = 'üìû ' + s.phone;
          meta.appendChild(ph);
        }
        if (typeof s.joinQueueLength === 'number' && s.joinQueueLength > 0) {
          const q = document.createElement('span');
          q.className = 'meta-pill';
          if (s.isProcessingJoin) {
            q.style.background = '#fef3c7';
            q.style.borderColor = 'var(--warning)';
            q.style.color = 'var(--warning)';
            q.innerHTML = '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è: <strong>' + s.joinQueueLength + '</strong>';
          } else {
            q.style.background = '#f3f4f6';
            q.style.borderColor = 'var(--border)';
            q.style.color = 'var(--text-light)';
            q.innerHTML = 'üìã –û—á–µ—Ä–µ–¥—å: <strong>' + s.joinQueueLength + '</strong>';
          }
          meta.appendChild(q);
        }
        if (s.intervals && typeof s.intervals.min === 'number' && typeof s.intervals.max === 'number') {
          const it = document.createElement('span');
          it.className = 'meta-pill';
          it.textContent = `‚è± ${s.intervals.min}-${s.intervals.max} —Å–µ–∫`;
          meta.appendChild(it);
        }
        if (s.lastJoin && s.lastJoin.link && s.lastJoin.at) {
          const lj = document.createElement('span');
          lj.className = 'meta-pill';
          const d = new Date(s.lastJoin.at);
          const t = d.toLocaleTimeString('ru-RU', { hour12: false });
          const day = d.toLocaleDateString('ru-RU');
          lj.textContent = `üîó –ü–æ—Å–ª–µ–¥–Ω–µ–µ: ${t} ${day}`;
          lj.title = `–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ:\n${s.lastJoin.link}`;
          meta.appendChild(lj);
        }
        left.appendChild(meta);

        const right = document.createElement('div');
        right.className = 'session-actions';
        right.style.display = 'flex';
        right.style.flexDirection = 'column';
        right.style.gap = '6px';
        right.style.alignItems = 'flex-end';

        // –ë–µ–π–¥–∂ –æ—á–µ—Ä–µ–¥–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
        if (s.joinQueueLength > 0) {
          const joinBadge = document.createElement('span');
          joinBadge.className = 'badge-number';
          joinBadge.textContent = s.joinQueueLength;
          joinBadge.title = '–ó–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è';
          right.appendChild(joinBadge);
        }

        const groupsBtn = document.createElement('button');
        groupsBtn.className = 'btn btn-sm btn-ghost';
        groupsBtn.textContent = 'üë• –ì—Ä—É–ø–ø—ã';
        groupsBtn.onclick = async (ev) => {
          ev.stopPropagation();
          try {
            const res = await fetch(`/api/tg/sessions/${encodeURIComponent(s.name)}/groups`);
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø');
            currentGroupsSession = s.name;
            lastGroups = data.groups || [];
            groupsTitle.textContent = `–ì—Ä—É–ø–ø—ã —Å–µ—Å—Å–∏–∏: ${s.name}`;
            renderGroups();
            groupsOverlay.style.display = 'flex';
          } catch (e) {
            log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø: ' + e.message, 'error');
          }
        };
        right.appendChild(groupsBtn);

        if (s.status === 'active') {
          // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º –≤ –≥—Ä—É–ø–ø—ã
          if (s.joinQueueLength > 0) {
            if (s.isProcessingJoin) {
              // –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
              const stopJoinBtn = document.createElement('button');
              stopJoinBtn.className = 'btn btn-sm btn-danger';
              stopJoinBtn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ';
              stopJoinBtn.onclick = async (ev) => {
                ev.stopPropagation();
                try {
                  const res = await fetch(`/api/tg/sessions/${encodeURIComponent(s.name)}/join/stop`, {
                    method: 'POST'
                  });
                  const data = await res.json();
                  if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
                  log(`‚èπÔ∏è –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—ã –¥–ª—è ${s.name} –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`, 'success');
                  await loadSessions();
                } catch (e) {
                  log('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è: ' + e.message, 'error');
                }
              };
              right.appendChild(stopJoinBtn);
            } else {
              // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
              const startJoinBtn = document.createElement('button');
              startJoinBtn.className = 'btn btn-sm';
              startJoinBtn.style.background = 'var(--success)';
              startJoinBtn.style.borderColor = 'var(--success)';
              startJoinBtn.style.color = 'white';
              startJoinBtn.textContent = '‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ';
              startJoinBtn.onclick = async (ev) => {
                ev.stopPropagation();
                try {
                  const res = await fetch(`/api/tg/sessions/${encodeURIComponent(s.name)}/join/start`, {
                    method: 'POST'
                  });
                  const data = await res.json();
                  if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞');
                  log(`‚ñ∂Ô∏è –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—ã –¥–ª—è ${s.name} –∑–∞–ø—É—â–µ–Ω–æ (${data.queueLength || s.joinQueueLength} –∑–∞–¥–∞—á)`, 'success');
                  await loadSessions();
                } catch (e) {
                  log('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è: ' + e.message, 'error');
                }
              };
              right.appendChild(startJoinBtn);
            }
          }

          // –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
          const broadcastBtn = document.createElement('button');
          broadcastBtn.className = 'btn btn-sm';
          broadcastBtn.style.background = 'var(--accent)';
          broadcastBtn.style.borderColor = 'var(--accent)';
          broadcastBtn.style.color = 'white';
          broadcastBtn.textContent = 'üì¢ –†–∞—Å—Å—ã–ª–∫–∞';
          broadcastBtn.onclick = async (ev) => {
            ev.stopPropagation();
            openBroadcastModal(s.name);
          };
          right.appendChild(broadcastBtn);

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
          (async () => {
            try {
              const broadcasts = await loadSessionBroadcasts(s.name);
              if (broadcasts && broadcasts.length > 0) {
                broadcasts.forEach(b => {
                  const progress = Math.round((b.sent / b.total) * 100);
                  const stopBroadcastBtn = document.createElement('button');
                  stopBroadcastBtn.className = 'btn btn-sm btn-danger';
                  stopBroadcastBtn.textContent = `‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É (${progress}%)`;
                  stopBroadcastBtn.title = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${b.sent}/${b.total}`;
                  stopBroadcastBtn.onclick = async (ev) => {
                    ev.stopPropagation();
                    if (!confirm(`–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –¥–ª—è —Å–µ—Å—Å–∏–∏ ${s.name}?`)) return;
                    try {
                      const res = await fetch(`/api/tg/broadcasts/${b.id}/stop`, {
                        method: 'POST'
                      });
                      const data = await res.json();
                      if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
                      log(`‚èπÔ∏è –†–∞—Å—Å—ã–ª–∫–∞ ${b.id} –¥–ª—è ${s.name} –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`, 'success');
                      await loadSessions();
                    } catch (e) {
                      log('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏: ' + e.message, 'error');
                    }
                  };
                  right.appendChild(stopBroadcastBtn);
                });
              }
            } catch (e) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Å—ã–ª–æ–∫:', e);
            }
          })();
        }

        if (s.status !== 'active') {
          const actBtn = document.createElement('button');
          actBtn.className = 'btn btn-sm btn-ghost';
          actBtn.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
          actBtn.onclick = async (ev) => {
            ev.stopPropagation();
            try {
              log(`–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ ${s.name}‚Ä¶`);
              const res = await fetch(`/api/tg/sessions/${encodeURIComponent(s.name)}/activate`, {
                method: 'POST',
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏');
              log(`–°–µ—Å—Å–∏—è ${s.name} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞`, 'success');
              await loadSessions();
            } catch (e) {
              log(`–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ ${s.name}: ${e.message}`, 'error');
            }
          };
          right.appendChild(actBtn);
        }

        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-danger';
        delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
        delBtn.onclick = async () => {
          if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é ${s.name}?`)) return;
          try {
            const res = await fetch(`/api/tg/sessions/${encodeURIComponent(s.name)}`, {
              method: 'DELETE'
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            log(`–°–µ—Å—Å–∏—è ${s.name} —É–¥–∞–ª–µ–Ω–∞`, 'success');
            loadSessions();
          } catch (e) {
            log(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è ${s.name}: ${e.message}`, 'error');
          }
        };
        right.appendChild(delBtn);

        main.appendChild(left);
        main.appendChild(right);
        card.appendChild(main);
        sessionsContainer.appendChild(card);

        card.onclick = () => {
          sessionNameInput.value = s.name;
          lastCreatedSession = s.name;
          currentStatusSpan.textContent = `–í—ã–±—Ä–∞–Ω–∞ —Å–µ—Å—Å–∏—è: ${s.name}`;
          if (s.intervals) {
            intervalMinInput.value = s.intervals.min ?? '';
            intervalMaxInput.value = s.intervals.max ?? '';
          }
        };
      });
    }

    async function loadSessions() {
      try {
        const res = await fetch('/api/tg/sessions');
        const data = await res.json();
        renderSessions(data || []);
      } catch (e) {
        log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–π: ' + e.message, 'error');
      }
    }

    async function loadSessionBroadcasts(sessionName) {
      try {
        const res = await fetch(`/api/tg/sessions/${encodeURIComponent(sessionName)}/broadcasts`);
        const data = await res.json();
        return data.broadcasts || [];
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Å—ã–ª–æ–∫:', e);
        return [];
      }
    }

    createSessionBtn.onclick = async () => {
      const name = sessionNameInput.value.trim();
      const phone = phoneInput.value.trim();
      if (!name || !phone) {
        log('–£–∫–∞–∂–∏—Ç–µ –∏–º—è —Å–µ—Å—Å–∏–∏ –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
        return;
      }
      try {
        currentStatusSpan.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏‚Ä¶';
        const res = await fetch('/api/tg/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, phone })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
        lastCreatedSession = data.name;
        log(`–°–µ—Å—Å–∏—è ${data.name} —Å–æ–∑–¥–∞–Ω–∞. –ö–æ–¥ –ø—Ä–∏–¥—ë—Ç –≤ Telegram`, 'success');
        currentStatusSpan.textContent = `–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è ${data.name}`;
        await loadSessions();
      } catch (e) {
        currentStatusSpan.textContent = '–û—à–∏–±–∫–∞';
        log('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏: ' + e.message, 'error');
      }
    };

    confirmCodeBtn.onclick = async () => {
      const code = authCodeInput.value.trim();
      const name = sessionNameInput.value.trim() || lastCreatedSession;
      if (!name) {
        log('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é', 'error');
        return;
      }
      if (!code) {
        log('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
        return;
      }
      try {
        currentStatusSpan.textContent = `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è ${name}‚Ä¶`;
        const res = await fetch(`/api/tg/sessions/${encodeURIComponent(name)}/confirm`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
        log(`–°–µ—Å—Å–∏—è ${name} —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞`, 'success');
        currentStatusSpan.textContent = `–°–µ—Å—Å–∏—è ${name} –∞–∫—Ç–∏–≤–Ω–∞`;
        authCodeInput.value = '';
        await loadSessions();
      } catch (e) {
        currentStatusSpan.textContent = '–û—à–∏–±–∫–∞';
        log('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–¥–∞: ' + e.message, 'error');
      }
    };

    joinGroupBtn.onclick = async () => {
      const name = sessionNameInput.value.trim() || lastCreatedSession;
      const link = joinLinkInput.value.trim();
      if (!name) {
        log('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é –¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è', 'error');
        return;
      }
      const trimmed = link.trim();
      const looksLikeTg =
        trimmed.startsWith('@') ||
        trimmed.toLowerCase().startsWith('t.me/') ||
        trimmed.toLowerCase().startsWith('http://t.me/') ||
        trimmed.toLowerCase().startsWith('https://t.me/');
      if (!trimmed || !looksLikeTg) {
        log('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É: https://t.me/..., t.me/username –∏–ª–∏ @username', 'error');
        return;
      }
      try {
        const res = await fetch(`/api/tg/sessions/${encodeURIComponent(name)}/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ link })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏');
        log(`–ó–∞–¥–∞—á–∞ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –¥–ª—è ${name} –¥–æ–±–∞–≤–ª–µ–Ω–∞: ${link}`, 'success');
        joinLinkInput.value = '';
        await loadSessions();
      } catch (e) {
        log('–û—à–∏–±–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è: ' + e.message, 'error');
      }
    };

    saveIntervalsBtn.onclick = async () => {
      const name = sessionNameInput.value.trim() || lastCreatedSession;
      if (!name) {
        log('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Å—Å–∏—é –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤', 'error');
        return;
      }
      const min = Number(intervalMinInput.value);
      const max = Number(intervalMaxInput.value);
      if (!Number.isFinite(min) || !Number.isFinite(max)) {
        log('–í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (—á–∏—Å–ª–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)', 'error');
        return;
      }
      if (min < 3 || max < min || max > 3600) {
        log('–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç 3 –¥–æ 3600 —Å–µ–∫, min ‚â§ max', 'error');
        return;
      }
      try {
        const res = await fetch(`/api/tg/sessions/${encodeURIComponent(name)}/intervals`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ min, max }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤');
        log(`–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è ${name} –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${min}-${max} —Å–µ–∫`, 'success');
        await loadSessions();
      } catch (e) {
        log('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤: ' + e.message, 'error');
      }
    };

    openNotificationsBtn.onclick = async () => {
      try {
        const res = await fetch('/api/tg/notifications?limit=200');
        const data = await res.json();
        lastNotifications = data.notifications || [];
        renderNotifications();
        notifOverlay.style.display = 'flex';
      } catch (e) {
        log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ' + e.message, 'error');
      }
    };

    closeNotificationsBtn.onclick = () => {
      notifOverlay.style.display = 'none';
    };

    clearNotificationsBtn.onclick = async () => {
      try {
        const res = await fetch('/api/tg/notifications', { method: 'DELETE' });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
        lastNotifications = [];
        renderNotifications();
        log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—á–∏—â–µ–Ω—ã', 'success');
      } catch (e) {
        log('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ' + e.message, 'error');
      }
    };

    closeGroupsBtn.onclick = () => {
      groupsOverlay.style.display = 'none';
    };

    function openBroadcastModal(sessionName) {
      currentBroadcastSession = sessionName;
      broadcastTitle.textContent = `üì¢ –†–∞—Å—Å—ã–ª–∫–∞: ${sessionName}`;
      broadcastText.value = '';
      broadcastMediaUrl.value = '';
      broadcastMediaType.value = '';
      broadcastMinInterval.value = '5';
      broadcastMaxInterval.value = '15';
      broadcastScheduled.checked = false;
      broadcastScheduleTime.value = '';
      broadcastScheduleTime.style.display = 'none';
      broadcastScheduleHelper.style.display = 'none';
      broadcastOverlay.style.display = 'flex';
    }

    broadcastScheduled.addEventListener('change', (e) => {
      if (e.target.checked) {
        broadcastScheduleTime.style.display = 'block';
        broadcastScheduleHelper.style.display = 'block';
      } else {
        broadcastScheduleTime.style.display = 'none';
        broadcastScheduleHelper.style.display = 'none';
      }
    });

    closeBroadcastBtn.onclick = () => {
      broadcastOverlay.style.display = 'none';
    };

    cancelBroadcastBtn.onclick = () => {
      broadcastOverlay.style.display = 'none';
    };

    startBroadcastBtn.onclick = async () => {
      if (!currentBroadcastSession) {
        log('–°–µ—Å—Å–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞', 'error');
        return;
      }

      const messageText = broadcastText.value.trim();
      const mediaUrl = broadcastMediaUrl.value.trim();
      const mediaType = broadcastMediaType.value;
      const minInterval = Number(broadcastMinInterval.value);
      const maxInterval = Number(broadcastMaxInterval.value);
      const isScheduled = broadcastScheduled.checked;
      const scheduleTime = broadcastScheduleTime.value.trim();

      if (!messageText && !mediaType) {
        log('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª', 'error');
        return;
      }

      if (mediaType && !mediaUrl) {
        log('–í–≤–µ–¥–∏—Ç–µ URL –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞', 'error');
        return;
      }

      if (!Number.isFinite(minInterval) || !Number.isFinite(maxInterval)) {
        log('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã', 'error');
        return;
      }

      if (minInterval < 3 || maxInterval < minInterval || maxInterval > 3600) {
        log('–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç 3 –¥–æ 3600 —Å–µ–∫, min ‚â§ max', 'error');
        return;
      }

      if (isScheduled && !scheduleTime) {
        log('–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏', 'error');
        return;
      }

      try {
        startBroadcastBtn.disabled = true;
        startBroadcastBtn.textContent = '‚è≥ –ó–∞–ø—É—Å–∫...';

        const body = {
          messageText: messageText || undefined,
          minInterval,
          maxInterval,
        };

        if (mediaType && mediaUrl) {
          body.mediaType = mediaType;
          body.mediaInfo = {
            url: mediaUrl,
            fileName: mediaUrl.split('/').pop()
          };
        }

        if (isScheduled) {
          body.scheduledTime = scheduleTime;
        }

        const res = await fetch(`/api/tg/sessions/${encodeURIComponent(currentBroadcastSession)}/broadcast`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏');

        if (isScheduled) {
          log(`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è ${currentBroadcastSession}. –ó–∞–ø—É—Å–∫: ${scheduleTime}`, 'success');
        } else {
          log(`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è ${currentBroadcastSession}. –ì—Ä—É–ø–ø: ${data.total || '–∑–∞–≥—Ä—É–∑–∫–∞...'}`, 'success');
        }

        broadcastOverlay.style.display = 'none';
      } catch (e) {
        log('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏: ' + e.message, 'error');
      } finally {
        startBroadcastBtn.disabled = false;
        startBroadcastBtn.innerHTML = '<span>üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</span>';
      }
    };

    // WebSocket for live updates
    const socket = io();
    socket.on('connect', () => {
      log('WS –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
    });
    socket.on('tg_session_status', () => {
      loadSessions();
    });
    socket.on('tg_join_queue_update', (data) => {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è
      loadSessions();
    });
    socket.on('tg_broadcast_started', (data) => {
      log(`üöÄ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ (ID: ${data.broadcastId})`, 'success');
    });
    socket.on('tg_broadcast_update', (data) => {
      const b = data.broadcast;
      if (b) {
        const progress = Math.round((b.sent / b.total) * 100);
        log(`üìä –†–∞—Å—Å—ã–ª–∫–∞ ${data.broadcastId}: ${b.sent}/${b.total} (${progress}%)`, 'info');
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        loadSessions();
      }
    });
    socket.on('tg_scheduled_broadcast_cancelled', (data) => {
      log(`‚ùå –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞: ${data.reason}`, 'error');
    });

    loadSessions();
  </script>
</body>
</html>


